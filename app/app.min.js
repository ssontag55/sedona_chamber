function startup(){that=this,that.gotoloc=[],that.loader=document.getElementById("loader"),that.points=L.geoJson(),that.token="pk.eyJ1Ijoic2Vkb25hY2hhbWJlciIsImEiOiJjaW13Zmp3cGswMzd0d2tsdXBnYmVjNmRjIn0.PlcjviLrxQht-_tBEbQQeg",L.mapbox.accessToken="pk.eyJ1Ijoic2Vkb25hY2hhbWJlciIsImEiOiJjaW13Zmp3cGswMzd0d2tsdXBnYmVjNmRjIn0.PlcjviLrxQht-_tBEbQQeg";var e=L.mapbox.map("map").setView([34.86494,-111.75786],16).addControl(L.mapbox.shareControl());that.map=e,that.browsertype="desktop",bowser.android||bowser.ios||bowser.mobile?(that.browsertype="mobile",e.on("popupopen",function(t){var a=e.project(t.popup._latlng);a.y-=t.popup._container.clientHeight/2-100,e.panTo(e.unproject(a),{animate:!0})}),$("#toolbar").css("padding-left","17%"),$("#pubartCarouselmobile").carousel({interval:88e3}),$("#pubartCarouselmobile").on("slid.bs.carousel",function(e){var t=$(e.relatedTarget).find(".col-sm-3").find(".thumbnail").attr("id");t&&d.eachLayer(function(e){e.feature.id==t&&layerpointclick(e)})})):$("#pubartCarousel").carousel({interval:88e3}),$("#search-bar").selectpicker({liveSearchPlaceholder:"Filter Locations...",noneSelectedText:"Find Locations...",header:"Select Location Types"}),$("#search-bar").show();var t=L.mapbox.featureLayer("data/basefeatures.json",{popupOptions:{closeButton:!0}}),a=L.mapbox.featureLayer("data/restaurant.json",{popupOptions:{closeButton:!0}}),o=L.mapbox.featureLayer("data/snl.json",{popupOptions:{closeButton:!0}}),r=L.mapbox.featureLayer("data/gallery.json",{popupOptions:{closeButton:!0}}),s=L.mapbox.featureLayer("data/bus.json",{popupOptions:{closeButton:!0}}),i=L.mapbox.featureLayer("data/theatre.json",{popupOptions:{closeButton:!0}}),n=L.mapbox.featureLayer("data/parking.json",{popupOptions:{closeButton:!0}}),l=L.mapbox.featureLayer("data/walking.json",{popupOptions:{closeButton:!0}}),c=L.mapbox.featureLayer("data/museum.json",{popupOptions:{closeButton:!0}}),d=L.mapbox.featureLayer("data/publicart.json",{popupOptions:{closeButton:!0}}),p=L.mapbox.featureLayer("data/recycling.json",{popupOptions:{closeButton:!0}}),u=L.mapbox.featureLayer("data/parks.json",{popupOptions:{closeButton:!0}}),h=L.mapbox.styleLayer("mapbox://styles/sedonachamber/cj0d9x1vd00012rlbjrrj7ciu",{maxZoom:20,zIndex:1e3});t.addTo(e),addMouseClickListener(t),a.on("ready",processLayerGeo),i.on("ready",processLayerGeo),n.on("ready",processLayerGeo),c.on("ready",processLayerGeo),r.on("ready",processLayerGeo),i.on("ready",processLayerGeo),s.on("ready",processLayerGeo),d.on("ready",processLayerGeo),u.on("ready",processLayerGeo),o.on("ready",processLayerGeo),window.location.href.indexOf("restaurants")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val","rest"),a.addTo(e),addMouseClickListener(a)):window.location.href.indexOf("green")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val","recycling"),p.addTo(e),addMouseClickListener(p)):window.location.href.indexOf("parks")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val","parks"),u.addTo(e),addMouseClickListener(u)):String(window.location.href).toUpperCase().indexOf("SNL")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val",["snl","walk","parking"]),n.addTo(e),o.addTo(e),l.addTo(e),addMouseClickListener(o)):window.location.href.indexOf("trails")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val","parks"),u.addTo(e),addMouseClickListener(u)):window.location.href.indexOf("publicart")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val",["pubart"]),d.addTo(e),addMouseClickListener(d),"mobile"==that.browsertype?$("#pubartCarouselmobile").show():$("#pubartCarousel").show()):window.location.href.indexOf("art")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val",["gallery","bus","walk","museum","theatre"]),i.addTo(e),c.addTo(e),n.addTo(e),s.addTo(e),r.addTo(e),l.addTo(e),addMouseClickListener(r)):window.location.href.indexOf("galleries")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val",["gallery","bus","walk","museum","theatre"]),i.addTo(e),c.addTo(e),r.addTo(e),s.addTo(e),l.addTo(e),addMouseClickListener(r)):window.location.href.indexOf("traffic")>-1?($("#search-bar").selectpicker("deselectAll"),$("#search-bar").selectpicker("val",["bus","parking","traffic"]),h.addTo(e),n.addTo(e),s.addTo(e),addMouseClickListener(n)):(a.addTo(e),i.addTo(e),n.addTo(e),c.addTo(e),r.addTo(e),s.addTo(e),l.addTo(e),addMouseClickListener(r),addMouseClickListener(a),addMouseClickListener(i),addMouseClickListener(n),addMouseClickListener(s),addMouseClickListener(c),addMouseClickListener(l)),$("#search-bar").on("changed.bs.select",function(t){var m=$("#search-bar").val();e.removeLayer(a),e.removeLayer(p),e.removeLayer(i),e.removeLayer(n),e.removeLayer(c),e.removeLayer(u),e.removeLayer(r),e.removeLayer(s),e.removeLayer(o),e.removeLayer(l),e.removeLayer(d),e.removeLayer(h),that.points=L.geoJson();var b=!1;if(m)for(var y=0;y<m.length;y++)"gallery"==m[y]?(r.addTo(e),processLayer2Geo(r),addMouseClickListener(r)):"rest"==m[y]?(processLayer2Geo(a),a.addTo(e),addMouseClickListener(a)):"theatre"==m[y]?(i.addTo(e),processLayer2Geo(i),addMouseClickListener(i)):"museum"==m[y]?(c.addTo(e),processLayer2Geo(c),addMouseClickListener(c)):"parking"==m[y]?(n.addTo(e),addMouseClickListener(n)):"parks"==m[y]?(u.addTo(e),addMouseClickListener(u)):"snl"==m[y]?(o.addTo(e),addMouseClickListener(o)):"pubart"==m[y]?(d.addTo(e),processLayer2Geo(d),addMouseClickListener(d),b=!0):"recycling"==m[y]?(p.addTo(e),processLayer2Geo(p),addMouseClickListener(p)):"bus"==m[y]?(s.addTo(e),addMouseClickListener(s)):"walk"==m[y]?(l.addTo(e),addMouseClickListener(l)):"traffic"==m[y]&&h.addTo(e);1==b?"mobile"==that.browsertype?$("#pubartCarouselmobile").show():$("#pubartCarousel").show():($("#pubartCarousel").hide(),$("#pubartCarouselmobile").hide())});var m,b=new Date;m=b.toString("dddd, MMMM dd, yyyy h:mm tt"),$(".thumbnail").on("click",function(e){var t=this.id;d.eachLayer(function(e){e.feature.id==t&&layerpointclick(e)})});var y=L.icon({iconUrl:"app/css/ripple.gif",iconAnchor:[10,10]}),g=L.control.locate({follow:!0,keepCurrentZoomLevel:!1,locateOptions:{maxZoom:16},metric:!1,showPopup:!0,markerClass:L.marker,markerStyle:{icon:y},strings:{title:"Show me where I am and what is closest to me!"},onLocationError:function(e){vex.dialog.buttons.YES.text="OK";var t="";bowser.msie?t="<a target='_blank' style='color:#7A1800' href='http://windows.microsoft.com/en-us/internet-explorer/ie-security-privacy-settings#ie=ie-11'>How To </a>":bowser.chrome?t="<a target='_blank' style='color:#7A1800' href='https://support.google.com/chrome/answer/142065?hl=en'>How To </a>":bowser.firefox?t="<a target='_blank' style='color:#7A1800' href='https://support.mozilla.org/en-US/kb/improve-mozilla-location-services-turning-location'>How To </a>":bowser.android?t="<a target='_blank' style='color:#7A1800' href='https://support.scruff.com/hc/en-us/articles/202623634-How-do-I-enable-location-services-on-my-Android-'>How To </a>":bowser.ios&&(t="<a target='_blank' style='color:#7A1800' href='https://support.apple.com/en-us/HT203033'>How To </a>"),vex.dialog.alert({message:"Please Enable Your Location to find best directions from where you are.<br><br>"+t}),that.loader.className="hide"}}).addTo(e);e.addControl(L.control.customsearch({position:"topleft"})),b.getHours()>19||b.getHours()<7?L.control.layers({Streets:L.mapbox.tileLayer("mapbox.streets",{maxZoom:20}),Earth:L.mapbox.tileLayer("mapbox.satellite",{maxZoom:20}),Dark:L.tileLayer("https://api.mapbox.com/styles/v1/sedonachamber/cin961o3z00epcxnhaxgzwdb6/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic2Vkb25hY2hhbWJlciIsImEiOiJjaW13Zmp3cGswMzd0d2tsdXBnYmVjNmRjIn0.PlcjviLrxQht-_tBEbQQeg",{maxZoom:20}).addTo(e)}).addTo(e):L.control.layers({Streets:L.mapbox.tileLayer("mapbox.streets",{maxZoom:20}),Earth:L.mapbox.tileLayer("mapbox.satellite",{maxZoom:20}),"Sedona Red":L.tileLayer("https://api.mapbox.com/styles/v1/sedonachamber/cin2kt8ku001sb4mawvdvwjxf/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic2Vkb25hY2hhbWJlciIsImEiOiJjaW13Zmp3cGswMzd0d2tsdXBnYmVjNmRjIn0.PlcjviLrxQht-_tBEbQQeg",{maxZoom:20}).addTo(e)}).addTo(e),that.loader.className="hide",e.on("locationfound",function(e){({type:"Feature",properties:{"marker-color":"#f00","marker-size":"small"},geometry:{type:"Point",coordinates:[e.longitude,e.latitude]}});if(0==that.gotoloc.length)if(jQuery.isEmptyObject(that.points._layers))vex.dialog.buttons.YES.text="OK",vex.dialog.alert({message:"Please Turn Layers on to Find Closest Location."});else{var t=L.GeometryUtil.closestLayer(that.map,that.points,e.latlng);bowser.android||bowser.ios||that.points.eachLayer(function(e){e.feature.properties.title===t.layer.feature.properties.title&&e.openPopup()}),e.accuracy>550?(that.map.setView(e.latlng,14),vex.dialog.buttons.YES.text="OK",vex.dialog.alert({message:"Your computer says you are over "+Number(e.accuracy/3.28084).toFixed(0)+" feet from here<br><br><br><b>Please enable wifi or use your phone to locate you."})):(that.map.setView(e.latlng,16),vex.dialog.buttons.YES.text="Get Directions",vex.dialog.alert({message:"You are within "+Number(e.accuracy/3.28084).toFixed(0)+" feet here!<br><br><i>"+t.layer.feature.properties.title+"</i> is closest to you.<br>",callback:function(a){if(1==a){var o=[t.layer.feature.geometry.coordinates[1],t.layer.feature.geometry.coordinates[0]];that.loader.className="",that.getdirections(e.latlng,o)}}}))}else"[object Array]"===Object.prototype.toString.call(that.gotoloc[0])?that.getdirections(e.latlng,that.gotoloc[0]):that.getdirections(e.latlng,that.gotoloc);that.map.stopLocate()});var f=L.Control.extend({options:{position:"bottomright"},onAdd:function(e){var t=L.DomUtil.create("div","img-control");return t}});e.addControl(new f),$(".img-control").click(function(){window.open("http://visitsedona.com/","_blank")}),vex.dialog.buttons.YES.text="Start Here",vex.dialog.buttons.NO.text="Browse Map",m="Celebrate the holiday season in Sedona, and witness the countryâ€™s largest 3D holiday light show in The Most Beautiful Place on Earth. Click on the Sedona Northern Lights layer to see Viewing Areas.<br><br>Press 'Start Here' to find closest location.<br><br>Use the drop down list <span class='caret'></span> at the <b>top</b> of the page to search more categories.<br><br>Use the <span class='fa fa-map-marker'></span> to the <b>left</b> to find yourself on the map.",5==b.getDay()&&b.getDate()<7?m+='<br><br><a target="_blank" style="color:#7A1800" href="http://sedonagalleryassociation.com/?page_id=236">First Friday Art Walk. Click here for more information.</a></i>':4==b.getDay()&&b.getDate()<7?m+='<br><br><a target="_blank" style="color:#7A1800" href="http://sedonagalleryassociation.com/?page_id=236">First Friday Art Walk is tomorrow. Click here for more information.</a></i>':(b.getHours()>18||b.getHours()<8)&&(m+="<br><br><i>Galleries may be closed in the evening.</i>"),vex.dialog.confirm({message:"<br><a target='_blank' href='http://visitsedona.com/'><img src='assets/big_sedona.png' style='padding-left:70px;padding-bottom:5px !important;padding-right:32px !important;'></></a><br><br>"+m,callback:function(e){1==e&&g.start()}})}function layerpointclick(e){e.openPopup(),map.setView(e._latlng,15),"mobile"==that.browsertype,map.panBy([0,-130]),"Point"==e.feature.geometry.type&&(that.gotoloc=[e.feature.geometry.coordinates[1],e.feature.geometry.coordinates[0]]),$("#direc").on("click",function(e){e.preventDefault(),that.loader.className="",that.map.stopLocate(),that.map.locate()})}function processLayerGeo(e){that.points.addData(e.target.getGeoJSON())}function processLayer2Geo(e){that.points.addData(e.getGeoJSON())}function addMouseClickListener(e){e.on("click",function(e){e.layer.openPopup(),"Point"==e.layer.feature.geometry.type&&(that.gotoloc=[e.layer.feature.geometry.coordinates[1],e.layer.feature.geometry.coordinates[0]]),$("#direc").on("click",function(e){e.preventDefault(),that.loader.className="",that.map.stopLocate(),that.map.locate()}),$("#moreinfo").on("click",function(e){e.preventDefault(),vex.dialog.buttons.YES.text="OK",vex.dialog.alert({message:e.currentTarget.title})}),that.layertitle=e.layer.feature.properties.title,that.id2send=String(e.layer.feature.properties.id).split("-")[1],$("#linksite").on("click",function(e){ga("send","event","linksite","click",that.layertitle);var t=(new Date).toJSON(),a=t.split("T")[0];({action:"updateHits",username:"SedonaMaps_API",password:"cart0gr@phick!",hittypeid:"4",recid:that.id2send,hitdate:a});$.ajax({url:"https://walksedona.com/php/updatehit.php?idval="+that.id2send+"&d="+a,success:function(e){},error:function(e,t,a){}})}),ga("send","event","marker","click",e.layer.feature.properties.title)})}function getdirections(e,t){that=this,that.directionlayer&&that.map.removeLayer(that.directionlayer),that.to&&that.map.removeLayer(that.to),that.from&&that.map.removeLayer(that.from),that.to=L.circle(t,26,{color:"#fff",fillColor:"#9E2C2E",fillOpacity:.7}).addTo(map),that.from=L.circle(e,26,{color:"#fff",fillColor:"#A1D490",fillOpacity:.7}).addTo(map).bindPopup("You are here.").bringToFront();var a="https://api.tiles.mapbox.com/v4/directions/mapbox.walking/"+e.lng+","+e.lat+";"+t[1]+","+t[0]+".json?instructions=json&geometry=line&access_token="+that.token;$.get(a,function(e){if(e.routes.length>0){var t={};t.geometry=e.routes[0].geometry,t.type="Feature",t.properties={};var a="<i>Walking Time: "+Number(e.routes[0].duration/19).toFixed(0)+" minutes<br><br>Walking Distance: "+Number(621371e-9*e.routes[0].distance).toFixed(0)+" miles",o={color:"#61C5BE",weight:5,dashArray:"5,10",opacity:.9};that.directionlayer=L.geoJson(t,o).bindPopup(a).addTo(that.map);var r=that.directionlayer.getBounds();bowser.android||bowser.ios?(that.map.fitBounds(r,{padding:[73,73]}),that.directionlayer.eachLayer(function(e){e.openPopup()})):(that.map.fitBounds(r,{padding:[15,15]}),that.directionlayer.eachLayer(function(e){e.openPopup()}))}else vex.dialog.alert({message:"No Current Directions, please try again."});that.gotoloc=[],that.loader.className="hide"})}