L.Control.customsearch=L.Control.extend({options:{showResultIcons:!1,collapsed:!0,expand:"click",position:"topright",placeholder:"Search Map...",errorMessage:"Nothing found.",suggestMinLength:3,suggestTimeout:250,defaultMarkGeocode:!0},includes:L.Mixin.Events,initialize:function(e){L.Util.setOptions(this,e),this.options.geocoder="custom",this.options.results=[],this._requestCount=0},onAdd:function(e){var t,o="leaflet-control-geocoder",s=L.DomUtil.create("div",o+" leaflet-bar"),i=L.DomUtil.create("button",o+"-icon",s),l=this._form=L.DomUtil.create("div",o+"-form",s);return this._map=e,this._container=s,i.innerHTML="&nbsp;",i.type="button",t=this._input=L.DomUtil.create("input","",l),t.type="text",t.placeholder=this.options.placeholder,this._errorElement=L.DomUtil.create("div",o+"-form-no-error",s),this._errorElement.innerHTML=this.options.errorMessage,this._alts=L.DomUtil.create("ul",o+"-alternatives leaflet-control-geocoder-alternatives-minimized",s),L.DomEvent.disableClickPropagation(this._alts),L.DomEvent.addListener(t,"keyup",this._keydown,this),L.DomEvent.addListener(t,"blur",function(){this.options.collapsed&&!this._preventBlurCollapse&&this._collapse(),this._preventBlurCollapse=!1},this),this.options.collapsed?"click"===this.options.expand?L.DomEvent.addListener(i,"click",function(e){0===e.button&&2!==e.detail&&this._toggle()},this):(L.DomEvent.addListener(i,"mouseover",this._expand,this),L.DomEvent.addListener(i,"mouseout",this._collapse,this),this._map.on("movestart",this._collapse,this)):(L.DomEvent.addListener(i,"click",function(e){this._geocode(e)},this),this._expand()),this.options.defaultMarkGeocode&&this.on("markgeocode",this.markGeocode,this),L.DomEvent.disableClickPropagation(s),s},_geocodeResult:function(e,t){if(t||1!==e.length){if(e.length>0){this._alts.innerHTML="",this._results=e,L.DomUtil.removeClass(this._alts,"leaflet-control-geocoder-alternatives-minimized");for(var o=0;o<e.length;o++)this._alts.appendChild(this._createAlt(e[o],o))}}else this._geocodeResultSelected(e[0])},markGeocode:function(e){e=e.geocode||e,this._map.setView([e.geometry.coordinates[1],e.geometry.coordinates[0]],17);for(var t in map._layers)if(map._layers[t].feature){var o=map._layers[t].feature;o.properties.id&&e.properties.id?o.properties.id.toLowerCase()==e.properties.id.toLowerCase()&&map._layers[t].openPopup():e.properties.id||o.properties.title.toLowerCase()==e.properties.title.toLowerCase()&&map._layers[t].openPopup()}return this},_geocode:function(e){var t=++this._requestCount,o=e?"suggest":"geocode",s={input:this._input.value};this._lastGeocode=this._input.value,e||this._clearResults(),this.fire("start"+o,s),t===this._requestCount&&""!=this._input.value&&this.options.results.length>0&&(s.results=this.options.results,this.fire("finish"+o,s),this._geocodeResult(this.options.results,e))},_geocodeResultSelected:function(e){this.options.collapsed||this._clearResults(),this.fire("markgeocode",{geocode:e})},_toggle:function(){this._container.className.indexOf("leaflet-control-geocoder-expanded")>=0?this._collapse():this._expand()},_expand:function(){L.DomUtil.addClass(this._container,"leaflet-control-geocoder-expanded"),this._input.select(),this.fire("expand")},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-geocoder-expanded",""),L.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized"),L.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error"),this.fire("collapse")},_clearResults:function(){L.DomUtil.addClass(this._alts,"leaflet-control-geocoder-alternatives-minimized"),this._selection=null,L.DomUtil.removeClass(this._errorElement,"leaflet-control-geocoder-error")},_createAlt:function(e,t){var o=L.DomUtil.create("li",""),s=L.DomUtil.create("a","",o),i=this.options.showResultIcons&&e.icon?L.DomUtil.create("img","",s):null,l=e.html?void 0:document.createTextNode(e.properties.title),r=function(t){this._preventBlurCollapse=!0,L.DomEvent.stop(t),this._geocodeResultSelected(e),L.DomEvent.on(o,"click",function(){this.options.collapsed&&this._collapse()},this)};return i&&(i.src=e.icon),o.setAttribute("data-result-index",t),e.html?s.innerHTML=s.innerHTML+e.html:s.appendChild(l),L.DomEvent.addListener(o,"mousedown",r,this),o},_keydown:function(e){var t=this,o=function(e){t._selection&&(L.DomUtil.removeClass(t._selection,"leaflet-control-geocoder-selected"),t._selection=t._selection[e>0?"nextSibling":"previousSibling"]),t._selection||(t._selection=t._alts[e>0?"firstChild":"lastChild"]),t._selection&&L.DomUtil.addClass(t._selection,"leaflet-control-geocoder-selected")};switch(e.keyCode){case 27:this.options.collapsed&&this._collapse();break;case 38:o(-1),L.DomEvent.preventDefault(e);break;case 40:o(1),L.DomEvent.preventDefault(e);break;case 13:if(this._selection){var s=parseInt(this._selection.getAttribute("data-result-index"),10);this._geocodeResultSelected(this._results[s]),this._clearResults()}else this._geocode();L.DomEvent.preventDefault(e);break;default:var i=this._input.value;if(""!=i){this._clearResults(),this.options.results=[];for(var l in map._layers)if(map._layers[l].feature){var r=map._layers[l].feature;map._layers[l].feature.properties.title&&r.properties.title.toLowerCase().search(i.toLowerCase())>-1&&this.options.results.length<9&&"Point"==r.geometry.type&&this.options.results.push(map._layers[l].feature)}this.options.results.length>0&&this._geocode(!1)}else this._clearResults(),this.options.results=[]}}}),L.control.customsearch=function(e){return new L.Control.customsearch(e)};